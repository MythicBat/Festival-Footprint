{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 360,
  "height": 360,
  "data": { "url": "data/festivals_by_month_percent.csv", "format": {"type":"csv"} },

  "params": [
    {
      "name": "radialHover_v4",
      "select": { "type": "point", "fields": ["month"], "on": "mouseover", "clear": "mouseout" }
    },
    {
      "name": "monthPick",
      "bind": { "input": "select", "options": ["All","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"] },
      "value": "All"
    }
  ],

  "transform": [
    {
      "calculate":
        "toNumber(replace(trim(isValid(datum.percent)?datum.percent:(isValid(datum.Percent)?datum.Percent:(isValid(datum[' percent'])?datum[' percent']:''))), '%',''))",
      "as": "pct"
    },

    { "calculate": "isFinite(datum.percent) ? datum.percent : datum.pct", "as": "percent_num" },

    {
      "calculate": "indexof(['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], datum.month)",
      "as": "mIndex"
    },

    { "filter": "monthPick == 'All' || datum.month == monthPick" },

    { "filter": "isFinite(datum.percent_num)" }
  ],

  "layer": [
    {
      "mark": { "type": "arc", "innerRadius": 80, "outerRadius": 150, "cornerRadius": 2 },
      "encoding": {
        "theta": { "field": "percent_num", "type": "quantitative", "stack": true, "title": "Share (%)" },
        "order": { "field": "mIndex" },
        "color": {
          "field": "month",
          "type": "nominal",
          "scale": { "scheme": "tableau10" },
          "legend": { "orient": "bottom", "columns": 4 }
        },
        "opacity": {
          "condition": { "param": "radialHover_v4", "empty": false, "value": 1 },
          "value": 0.65
        },
        "tooltip": [
          { "field": "month" },
          { "field": "percent_num", "title": "Share (%)", "format": ".1f" }
        ]
      }
    },
    {
      "transform": [ { "filter": { "param": "radialHover_v4" } } ],
      "mark": { "type": "text", "radius": 60, "fontWeight": "bold", "fontSize": 16 },
      "encoding": { "text": { "field": "month" } }
    }
  ],

  "view": { "stroke": null }
}
